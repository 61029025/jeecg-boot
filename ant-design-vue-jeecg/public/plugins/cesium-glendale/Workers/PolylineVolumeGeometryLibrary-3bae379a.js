define(["exports","./when-54c2dc71","./Math-fc8cecf5","./Cartesian3-e5933291","./Matrix4-a018fd55","./Cartesian2-b1f4b655","./Transforms-b0e569fa","./EllipsoidTangentPlane-6d5e3584","./PolylinePipeline-1acb3556"],function(a,J,K,W,X,S,D,G,$){"use strict";var aa=Object.freeze({ROUNDED:0,MITERED:1,BEVELED:2}),ea=[new W.Cartesian3,new W.Cartesian3],ra=new W.Cartesian3,na=new W.Cartesian3,ta=new W.Cartesian3,ia=new W.Cartesian3,sa=new W.Cartesian3,oa=new W.Cartesian3,la=new W.Cartesian3,Ca=new W.Cartesian3,ca=new W.Cartesian3,ua=new W.Cartesian3,w=new W.Cartesian3,ya={},da=new S.Cartographic;function ma(a,e,r,n){var t=a[0],i=a[1],s=W.Cartesian3.angleBetween(t,i),o=Math.ceil(s/n),l=new Array(o);if(e===r){for(c=0;c<o;c++)l[c]=e;return l.push(r),l}for(var C=(r-e)/o,c=1;c<o;c++){var u=e+c*C;l[c]=u}return l[0]=e,l.push(r),l}var L=new W.Cartesian3,N=new W.Cartesian3;var O=new W.Cartesian3(-1,0,0),I=new X.Matrix4,V=new X.Matrix4,_=new X.Matrix3,Q=X.Matrix3.IDENTITY.clone(),R=new W.Cartesian3,j=new X.Cartesian4,U=new W.Cartesian3;function fa(a,e,r,n,t,i,s,o,l,C,c,u){var y,d,m,f,w,x,p,g,v,h,M,P,T,z,E,B=j;I=D.Transforms.eastNorthUpToFixedFrame(a,t,I),J.defined(C)||(C=new W.Cartesian3),_=0===C.z?(y=R,y=X.Matrix4.multiplyByPointAsVector(I,O,y),y=W.Cartesian3.normalize(y,y),g=y,v=e,h=a,M=t,P=new G.EllipsoidTangentPlane(h,M),T=P.projectPointOntoPlane(W.Cartesian3.add(h,g,L),L),z=P.projectPointOntoPlane(W.Cartesian3.add(h,v,N),N),E=S.Cartesian2.angleBetween(T,z),d=0<=z.x*T.y-z.y*T.x?-E:E,X.Matrix3.fromRotationZ(d)):(m=W.Cartesian3.subtract(l[1],l[0],new W.Cartesian3),m=W.Cartesian3.normalize(m,m),f=new W.Cartesian3(0,0,-1),w=new W.Cartesian3,W.Cartesian3.cross(f,m,w),W.Cartesian3.magnitude(w)<1e-5&&(w=f),W.Cartesian3.normalize(w,w),x=W.Cartesian3.angleBetween(f,m),p=D.Quaternion.fromAxisAngle(w,x),X.Matrix3.fromQuaternion(p)),U.z=i,I=X.Matrix4.multiplyTransformation(I,X.Matrix4.fromRotationTranslation(_,U,V),I);var b=Q;b[0]=s;for(var A=0;A<o;A++)for(var F=0;F<r.length;F+=3)B=W.Cartesian3.fromArray(r,F,B),B=X.Matrix3.multiplyByVector(b,B,B),B=X.Matrix4.multiplyByPoint(I,B,B),1===c&&(B=X.Matrix4.multiplyByPoint(u,B,B)),n.push(B.x,B.y,B.z);return n}var y=new W.Cartesian3;function wa(a,e,r,n,t,i,s,o,l,C,c){for(var u=0;u<a.length;u+=3){n=fa(W.Cartesian3.fromArray(a,u,y),e,r,n,t,i[u/3],s,1,o,l,C,c)}return n}function xa(a,e,r){var n=a.length,t=new Array(3*n),i=0,s=e.x+e.width/2,o=e.y+e.height/2;if(J.defined(r)||(r=new W.Cartesian3),0===r.z)for(var l=0;l<n;l++)t[i++]=a[l].x-s,t[i++]=0,t[i++]=a[l].y-o;else for(l=0;l<n;l++)t[i++]=a[l].x-s,t[i++]=a[l].y-o,t[i++]=0;return t}var x=new D.Quaternion,p=new W.Cartesian3,g=new X.Matrix3;function pa(a,e,r,n,t,i,s,o,l,C){var c,u=W.Cartesian3.angleBetween(W.Cartesian3.subtract(e,a,ua),W.Cartesian3.subtract(r,a,w)),y=n===aa.BEVELED?0:Math.ceil(u/K.CesiumMath.toRadians(5)),d=t?X.Matrix3.fromQuaternion(D.Quaternion.fromAxisAngle(W.Cartesian3.negate(a,ua),u/(y+1),x),g):X.Matrix3.fromQuaternion(D.Quaternion.fromAxisAngle(a,u/(y+1),x),g);if(e=W.Cartesian3.clone(e,p),0<y)for(var m=C?2:1,f=0;f<y;f++)e=X.Matrix3.multiplyByVector(d,e,e),c=W.Cartesian3.subtract(e,a,ua),c=W.Cartesian3.normalize(c,c),t||(c=W.Cartesian3.negate(c,c)),s=fa(i.scaleToGeodeticSurface(e,w),c,o,s,i,l,1,m,isFromGLP,inverseMat);else c=W.Cartesian3.subtract(e,a,ua),c=W.Cartesian3.normalize(c,c),t||(c=W.Cartesian3.negate(c,c)),s=fa(i.scaleToGeodeticSurface(e,w),c,o,s,i,l,1,1,isFromGLP,inverseMat),r=W.Cartesian3.clone(r,p),c=W.Cartesian3.subtract(r,a,ua),c=W.Cartesian3.normalize(c,c),t||(c=W.Cartesian3.negate(c,c)),s=fa(i.scaleToGeodeticSurface(r,w),c,o,s,i,l,1,1,isFromGLP,inverseMat);return s}ya.removeDuplicatesFromShape=function(a){for(var e=a.length,r=[],n=e-1,t=0;t<e;n=t++){var i=a[n],s=a[t];S.Cartesian2.equals(i,s)||r.push(s)}return r},ya.angleIsGreaterThanPi=function(a,e,r,n){var t=new G.EllipsoidTangentPlane(r,n),i=t.projectPointOntoPlane(W.Cartesian3.add(r,a,L),L),s=t.projectPointOntoPlane(W.Cartesian3.add(r,e,N),N);return 0<=s.x*i.y-s.y*i.x};var ga=new W.Cartesian3,va=new W.Cartesian3;ya.computePositions=function(a,e,r,n,t){var i=n._ellipsoid,s=a.slice(0),o=[],l=new W.Cartesian3,C=new W.Cartesian3;W.Cartesian3.clone(s[0],l),W.Cartesian3.clone(s[1],C);var c=new X.Matrix4;null!=n._rootTransform&&!n._rootTransform.equals(new X.Matrix4)||(n._rootTransform=X.Matrix4.IDENTITY),X.Matrix4.inverse(n._rootTransform,c),X.Matrix4.multiplyByPoint(c,l,l),X.Matrix4.multiplyByPoint(c,C,C),o.push(l),o.push(C);var u=W.Cartesian3.clone(C,new W.Cartesian3);u.x=+u.x.toFixed(4),u.y=+u.y.toFixed(4),u.z=+u.z.toFixed(4);var y=W.Cartesian3.clone(l,new W.Cartesian3);y.x=+y.x.toFixed(4),y.y=+y.y.toFixed(4),y.z=+y.z.toFixed(4);W.Cartesian3.subtract(u,y,new W.Cartesian3);var d=function(a,e){for(var r=new Array(a.length),n=0;n<a.length;n++){var t=a[n];da=e.cartesianToCartographic(t,da),r[n]=da.height,a[n]=e.scaleToGeodeticSurface(t,t)}return r}(a,i),m=d[0].toFixed(2),f=d[1].toFixed(2),w=new W.Cartesian3(0,0,+(m-f).toFixed(2)),x=n._granularity,p=n._cornerType,g=(t?function(a,e,r){var n=a.length,t=new Array(6*n),i=0,s=e.x+e.width/2,o=e.y+e.height/2;if(J.defined(r)||(r=new W.Cartesian3),0===r.z){var l=a[0];t[i++]=l.x-s,t[i++]=0,t[i++]=l.y-o;for(var C=1;C<n;C++){var c=(l=a[C]).x-s,u=l.y-o;t[i++]=c,t[i++]=0,t[i++]=u,t[i++]=c,t[i++]=0,t[i++]=u}l=a[0],t[i++]=l.x-s,t[i++]=0,t[i++]=l.y-o}else{l=a[0];t[i++]=l.x-s,t[i++]=l.y-o,t[i++]=0;for(C=1;C<n;C++){c=(l=a[C]).x-s,u=l.y-o;t[i++]=c,t[i++]=u,t[i++]=0,t[i++]=c,t[i++]=u,t[i++]=0}l=a[0],t[i++]=l.x-s,t[i++]=l.y-o,t[i++]=0}return t}:xa)(e,r,w),v=t?xa(e,r,w):void 0,h=r.height/2,M=r.width/2,P=a.length,T=[],z=t?[]:void 0,E=ra,B=na,b=ta,A=ia,F=sa,S=oa,D=la,G=Ca,L=ca,N=a[0],O=a[1],I=n._isFromGLP,A=i.geodeticSurfaceNormal(N,A);E=W.Cartesian3.subtract(O,N,E),E=W.Cartesian3.normalize(E,E),G=W.Cartesian3.cross(A,E,G),G=W.Cartesian3.normalize(G,G);var V,_=d[0],Q=d[1];t&&(z=fa(N,G,v,z,i,_+h,1,1,o,w,I,c)),L=W.Cartesian3.clone(N,L),N=O,B=W.Cartesian3.negate(E,B);for(var R=1;R<P-1;R++){var j=t?2:1,O=a[R+1],E=W.Cartesian3.subtract(O,N,E);E=W.Cartesian3.normalize(E,E),b=W.Cartesian3.add(E,B,b),b=W.Cartesian3.normalize(b,b),A=i.geodeticSurfaceNormal(N,A);var U=W.Cartesian3.multiplyByScalar(A,W.Cartesian3.dot(E,A),ga);W.Cartesian3.subtract(E,U,U),W.Cartesian3.normalize(U,U);var q,Y,Z=W.Cartesian3.multiplyByScalar(A,W.Cartesian3.dot(B,A),va);W.Cartesian3.subtract(B,Z,Z),W.Cartesian3.normalize(Z,Z),!K.CesiumMath.equalsEpsilon(Math.abs(W.Cartesian3.dot(U,Z)),1,K.CesiumMath.EPSILON7)?(b=W.Cartesian3.cross(b,A,b),b=W.Cartesian3.cross(A,b,b),b=W.Cartesian3.normalize(b,b),q=1/Math.max(.25,W.Cartesian3.magnitude(W.Cartesian3.cross(b,B,ua))),(Y=ya.angleIsGreaterThanPi(E,B,N,i))?(F=W.Cartesian3.add(N,W.Cartesian3.multiplyByScalar(b,q*M,b),F),S=W.Cartesian3.add(F,W.Cartesian3.multiplyByScalar(G,M,S),S),ea[0]=W.Cartesian3.clone(L,ea[0]),ea[1]=W.Cartesian3.clone(S,ea[1]),V=ma(ea,_+h,Q+h,x),T=wa($.PolylinePipeline.generateArc({positions:ea,granularity:x,ellipsoid:i}),G,g,T,i,V,1,o,w,I,c),G=W.Cartesian3.cross(A,E,G),G=W.Cartesian3.normalize(G,G),D=W.Cartesian3.add(F,W.Cartesian3.multiplyByScalar(G,M,D),D),p===aa.ROUNDED||p===aa.BEVELED?pa(F,S,D,p,Y,i,T,g,Q+h,t):T=fa(N,b=W.Cartesian3.negate(b,b),g,T,i,Q+h,q,j,I,c)):(F=W.Cartesian3.add(N,W.Cartesian3.multiplyByScalar(b,q*M,b),F),S=W.Cartesian3.add(F,W.Cartesian3.multiplyByScalar(G,-M,S),S),ea[0]=W.Cartesian3.clone(L,ea[0]),ea[1]=W.Cartesian3.clone(S,ea[1]),V=ma(ea,_+h,Q+h,x),T=wa($.PolylinePipeline.generateArc({positions:ea,granularity:x,ellipsoid:i}),G,g,T,i,V,1,o,w,I,c),G=W.Cartesian3.cross(A,E,G),G=W.Cartesian3.normalize(G,G),D=W.Cartesian3.add(F,W.Cartesian3.multiplyByScalar(G,-M,D),D),p===aa.ROUNDED||p===aa.BEVELED?pa(F,S,D,p,Y,i,T,g,Q+h,t):T=fa(N,b,g,T,i,Q+h,q,j,I,c)),L=W.Cartesian3.clone(D,L),B=W.Cartesian3.negate(E,B)):(T=fa(L,G,g,T,i,_+h,1,1,I,c),L=N),_=Q,Q=d[R+1],N=O}ea[0]=W.Cartesian3.clone(L,ea[0]),ea[1]=W.Cartesian3.clone(N,ea[1]),V=ma(ea,_+h,Q+h,x),T=wa($.PolylinePipeline.generateArc({positions:ea,granularity:x,ellipsoid:i}),G,g,T,i,V,1,o,w,I,c),t&&(z=fa(N,G,v,z,i,Q+h,1,1,o,w,I,c)),P=T.length;var k=t?P+z.length:P,H=new Float64Array(k);return H.set(T),t&&H.set(z,P),H},a.CornerType=aa,a.PolylineVolumeGeometryLibrary=ya});
