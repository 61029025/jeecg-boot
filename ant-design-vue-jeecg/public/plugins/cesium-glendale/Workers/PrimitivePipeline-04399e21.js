define(["exports","./when-54c2dc71","./Check-6c0211bc","./Cartesian3-e5933291","./ComponentDatatype-6d99a1ee","./Matrix4-a018fd55","./Cartesian2-b1f4b655","./Transforms-b0e569fa","./GeometryAttribute-95a2a7cd","./GeometryAttributes-4fcfcf40","./GeometryPipeline-74a20bc7","./IndexDatatype-53503fee","./WebMercatorProjection-0e41bb58"],function(e,v,t,w,k,c,m,A,V,O,x,L,h){"use strict";function l(e,t,r){e=v.defaultValue(e,0),t=v.defaultValue(t,0),r=v.defaultValue(r,0),this.value=new Float32Array([e,t,r])}function P(e,t,r){var n=!r,i=e.length;if(!n&&1<i)for(var o=e[0].modelMatrix,a=1;a<i;++a)if(!c.Matrix4.equals(o,e[a].modelMatrix)){n=!0;break}if(n)for(a=0;a<i;++a)v.defined(e[a].geometry)&&x.GeometryPipeline.transformToWorldCoordinates(e[a]);else c.Matrix4.multiplyTransformation(t,e[0].modelMatrix,t)}function i(e,t){var r=e.attributes,n=r.position,i=n.values.length/n.componentsPerAttribute;r.batchId=new V.GeometryAttribute({componentDatatype:k.ComponentDatatype.FLOAT,componentsPerAttribute:1,values:new Float32Array(i)});for(var o=r.batchId.values,a=0;a<i;++a)o[a]=t}function G(e){for(var t=e.length,r=0;r<t;++r){var n=e[r];v.defined(n.geometry)?i(n.geometry,r):v.defined(n.westHemisphereGeometry)&&v.defined(n.eastHemisphereGeometry)&&(i(n.westHemisphereGeometry,r),i(n.eastHemisphereGeometry,r))}}function n(e,t,r,n){var i,o,a,s,d=n.length-1;s=0<=d?(o=(i=n[d]).offset+i.count,r[a=i.index].indices.length):r[a=o=0].indices.length;for(var p=e.length,f=0;f<p;++f){var u,c=e[f][t];v.defined(c)&&(s<o+(u=c.indices.length)&&(o=0,s=r[++a].indices.length),n.push({index:a,offset:o,count:u}),o+=u)}}function g(e,t){var r=[];return n(e,"geometry",t,r),n(e,"westHemisphereGeometry",t,r),n(e,"eastHemisphereGeometry",t,r),r}Object.defineProperties(l.prototype,{componentDatatype:{get:function(){return k.ComponentDatatype.FLOAT}},componentsPerAttribute:{get:function(){return 3}},normalize:{get:function(){return!1}}}),l.fromCartesian3=function(e){return new l(e.x,e.y,e.z)},l.toValue=function(e,t){return v.defined(t)||(t=new Float32Array([e.x,e.y,e.z])),t[0]=e.x,t[1]=e.y,t[2]=e.z,t};var y={};function o(e,t){for(var r=e.length,n=0;n<r;++n)!function(e,t){var r,n,i=e.attributes;for(r in i){i.hasOwnProperty(r)&&(n=i[r],v.defined(n)&&v.defined(n.values)&&t.push(n.values.buffer))}v.defined(e.indices)&&t.push(e.indices.buffer)}(e[n],t)}function a(e){var t=e.length,r=1+(A.BoundingSphere.packedLength+1)*t,n=new Float32Array(r),i=0;n[i++]=t;for(var o=0;o<t;++o){var a=e[o];v.defined(a)?(n[i++]=1,A.BoundingSphere.pack(e[o],n,i)):n[i++]=0,i+=A.BoundingSphere.packedLength}return n}function r(e){for(var t=new Array(e[0]),r=0,n=1;n<e.length;)1===e[n++]&&(t[r]=A.BoundingSphere.unpack(e,n)),++r,n+=A.BoundingSphere.packedLength;return t}y.combineGeometry=function(e){var t,r,n,i,o=e.instances,a=o.length,s=!1;0<a&&(0<(t=function(e){var t,r=e.instances,n=e.projection,i=e.elementIndexUintSupported,o=e.scene3DOnly,a=e.vertexCacheOptimize,s=e.compressVertices,d=e.modelMatrix,p=e.isfromGLP,f=r.length;for(b=0;b<f;++b)if(v.defined(r[b].geometry)){r[b].geometry.primitiveType;break}if(P(r,d,o),!o)for(b=0;b<f;++b)v.defined(r[b].geometry)&&x.GeometryPipeline.splitLongitude(r[b]);if(G(r),a)for(b=0;b<f;++b){var u=r[b];v.defined(u.geometry)?(x.GeometryPipeline.reorderForPostVertexCache(u.geometry),x.GeometryPipeline.reorderForPreVertexCache(u.geometry)):v.defined(u.westHemisphereGeometry)&&v.defined(u.eastHemisphereGeometry)&&(x.GeometryPipeline.reorderForPostVertexCache(u.westHemisphereGeometry),x.GeometryPipeline.reorderForPreVertexCache(u.westHemisphereGeometry),x.GeometryPipeline.reorderForPostVertexCache(u.eastHemisphereGeometry),x.GeometryPipeline.reorderForPreVertexCache(u.eastHemisphereGeometry))}var c=x.GeometryPipeline.combineInstances(r);for(f=c.length,b=0;b<f;++b){var m,h,l,g=(t=c[b]).attributes;if(o){if(!p)for(m in g)g.hasOwnProperty(m)&&g[m].componentDatatype===k.ComponentDatatype.DOUBLE&&x.GeometryPipeline.encodeAttribute(t,m,m+"3DHigh",m+"3DLow")}else for(m in g){g.hasOwnProperty(m)&&g[m].componentDatatype===k.ComponentDatatype.DOUBLE&&(h=m+"3D",l=m+"2D",x.GeometryPipeline.projectTo2D(t,m,h,l,n),v.defined(t.boundingSphere)&&"position"===m&&(t.boundingSphereCV=A.BoundingSphere.fromVertices(t.attributes.position2D.values)),x.GeometryPipeline.encodeAttribute(t,h,h+"High",h+"Low"),x.GeometryPipeline.encodeAttribute(t,l,l+"High",l+"Low"))}s&&x.GeometryPipeline.compressVertices(t)}if(!i){for(var y=[],f=c.length,b=0;b<f;++b)t=c[b],y=y.concat(x.GeometryPipeline.fitToUnsignedShortIndices(t));c=y}return c}(e)).length&&(r=x.GeometryPipeline.createAttributeLocations(t[0]),e.createPickOffsets&&(n=g(o,t))),v.defined(o[0].attributes)&&v.defined(o[0].attributes.offset)&&(i=new Array(a),s=!0));for(var d=new Array(a),p=new Array(a),f=new Array(a),u=0;u<a;++u){var c=o[u],m=c.geometry;v.defined(m)&&(d[u]=m.boundingSphere,p[u]=m.boundingSphereCV,f[u]=[m.MaxPoint,m.MinPoint],s&&(i[u]=c.geometry.offsetAttribute));var h=c.eastHemisphereGeometry,l=c.westHemisphereGeometry;v.defined(h)&&v.defined(l)&&(v.defined(h.boundingSphere)&&v.defined(l.boundingSphere)&&(d[u]=A.BoundingSphere.union(h.boundingSphere,l.boundingSphere)),v.defined(h.boundingSphereCV)&&v.defined(l.boundingSphereCV)&&(p[u]=A.BoundingSphere.union(h.boundingSphereCV,l.boundingSphereCV)))}return{geometries:t,modelMatrix:e.modelMatrix,attributeLocations:r,pickOffsets:n,offsetInstanceExtend:i,boundingSpheres:d,boundingSpheresCV:p,MaxMinArr:f}},y.combineGeometryNonCompressed=function(e){var t,r,n,i,o=e.instances,a=o.length,s=!1;0<a&&(0<(t=function(e){for(var t=e.instances,r=(e.projection,e.elementIndexUintSupported,e.scene3DOnly),n=e.vertexCacheOptimize,i=(e.compressVertices,e.modelMatrix),o=t.length,a=0;a<o;++a)if(v.defined(t[a].geometry)){t[a].geometry.primitiveType;break}if(P(t,i,r),!r)for(a=0;a<o;++a)v.defined(t[a].geometry)&&x.GeometryPipeline.splitLongitude(t[a]);if(G(t),n)for(a=0;a<o;++a){var s=t[a];v.defined(s.geometry)?(x.GeometryPipeline.reorderForPostVertexCache(s.geometry),x.GeometryPipeline.reorderForPreVertexCache(s.geometry)):v.defined(s.westHemisphereGeometry)&&v.defined(s.eastHemisphereGeometry)&&(x.GeometryPipeline.reorderForPostVertexCache(s.westHemisphereGeometry),x.GeometryPipeline.reorderForPreVertexCache(s.westHemisphereGeometry),x.GeometryPipeline.reorderForPostVertexCache(s.eastHemisphereGeometry),x.GeometryPipeline.reorderForPreVertexCache(s.eastHemisphereGeometry))}return x.GeometryPipeline.combineInstances(t)}(e)).length&&(r=x.GeometryPipeline.createAttributeLocations(t[0]),e.createPickOffsets&&(n=g(o,t))),v.defined(o[0].attributes)&&v.defined(o[0].attributes.offset)&&(i=new Array(a),s=!0));for(var d=new Array(a),p=new Array(a),f=new Array(a),u=0;u<a;++u){var c=o[u],m=c.geometry;v.defined(m)&&(d[u]=m.boundingSphere,p[u]=m.boundingSphereCV,f[u]=[m.MaxPoint,m.MinPoint],s&&(i[u]=c.geometry.offsetAttribute));var h=c.eastHemisphereGeometry,l=c.westHemisphereGeometry;v.defined(h)&&v.defined(l)&&(v.defined(h.boundingSphere)&&v.defined(l.boundingSphere)&&(d[u]=A.BoundingSphere.union(h.boundingSphere,l.boundingSphere)),v.defined(h.boundingSphereCV)&&v.defined(l.boundingSphereCV)&&(p[u]=A.BoundingSphere.union(h.boundingSphereCV,l.boundingSphereCV)))}return{geometries:t,modelMatrix:e.modelMatrix,attributeLocations:r,pickOffsets:n,offsetInstanceExtend:i,boundingSpheres:d,boundingSpheresCV:p,MaxMinArr:f}},y.packCreateGeometryResults=function(e,t){var r=new Float64Array(function(e){for(var t=1,r=e.length,n=0;n<r;n++){var i=e[n];if(++t,v.defined(i)){var o,a=i.attributes;for(o in t+=8+(v.defined(i.MaxPoint)?6:0)+2*A.BoundingSphere.packedLength+(v.defined(i.indices)?i.indices.length:0),a){a.hasOwnProperty(o)&&v.defined(a[o])&&(t+=5+a[o].values.length)}}}return t}(e)),n=[],i={},o=e.length,a=0;r[a++]=o;for(var s=0;s<o;s++){var d=e[s],p=v.defined(d);if(r[a++]=p?1:0,p){r[a++]=d.primitiveType,r[a++]=d.geometryType,v.defined(d.MaxPoint)?(r[a++]=1,r[a++]=d.MaxPoint.x,r[a++]=d.MaxPoint.y,r[a++]=d.MaxPoint.z,r[a++]=d.MinPoint.x,r[a++]=d.MinPoint.y,r[a++]=d.MinPoint.z):r[a++]=0,r[a++]=v.defaultValue(d.offsetAttribute,-1);var f=v.defined(d.boundingSphere)?1:0;(r[a++]=f)&&A.BoundingSphere.pack(d.boundingSphere,r,a),a+=A.BoundingSphere.packedLength;var u=v.defined(d.boundingSphereCV)?1:0;(r[a++]=u)&&A.BoundingSphere.pack(d.boundingSphereCV,r,a),a+=A.BoundingSphere.packedLength;var c,m=d.attributes,h=[];for(c in m)m.hasOwnProperty(c)&&v.defined(m[c])&&(h.push(c),v.defined(i[c])||(i[c]=n.length,n.push(c)));r[a++]=h.length;for(var l=0;l<h.length;l++){var g=h[l],y=m[g];r[a++]=i[g],r[a++]=y.componentDatatype,r[a++]=y.componentsPerAttribute,r[a++]=y.normalize?1:0,r[a++]=y.values.length,r.set(y.values,a),a+=y.values.length}var b=v.defined(d.indices)?d.indices.length:0;0<(r[a++]=b)&&(r.set(d.indices,a),a+=b)}}return t.push(r.buffer),{stringTable:n,packedData:r}},y.unpackCreateGeometryResults=function(e){for(var t=e.stringTable,r=e.packedData,n=new Array(r[0]),i=0,o=1;o<r.length;){if(1===r[o++]){var a=r[o++],s=r[o++],d=r[o++],p=new w.Cartesian3,f=new w.Cartesian3;1===d&&(p.x=r[o++],p.y=r[o++],p.z=r[o++],f.x=r[o++],f.y=r[o++],f.z=r[o++]);var u,c,m=r[o++];-1===m&&(m=void 0),1===r[o++]&&(u=A.BoundingSphere.unpack(r,o)),o+=A.BoundingSphere.packedLength,1===r[o++]&&(c=A.BoundingSphere.unpack(r,o)),o+=A.BoundingSphere.packedLength;var h=new O.GeometryAttributes,l=r[o++];for(M=0;M<l;M++){for(var g=t[r[o++]],y=r[o++],b=r[o++],v=0!==r[o++],x=r[o++],P=k.ComponentDatatype.createTypedArray(y,x),G=0;G<x;G++)P[G]=r[o++];h[g]=new V.GeometryAttribute({componentDatatype:y,componentsPerAttribute:b,normalize:v,values:P})}if(0<(x=r[o++]))for(var S=P.length/b,C=L.IndexDatatype.createTypedArray(S,x),M=0;M<x;M++)C[M]=r[o++];n[i++]=new V.Geometry({primitiveType:a,geometryType:s,boundingSphere:u,boundingSphereCV:c,indices:C,attributes:h,offsetAttribute:m,MaxPoint:p,MinPoint:f})}else n[i++]=void 0}return n},y.packCombineGeometryParameters=function(e,t){for(var r=e.createGeometryResults,n=r.length,i=0;i<n;i++)t.push(r[i].packedData.buffer);return{createGeometryResults:e.createGeometryResults,packedInstances:function(e,t){var r=e.length,n=new Float64Array(1+19*r),i=0;n[i++]=r;for(var o=0;o<r;o++){var a,s=e[o];c.Matrix4.pack(s.modelMatrix,n,i),i+=c.Matrix4.packedLength,v.defined(s.attributes)&&v.defined(s.attributes.offset)&&(a=s.attributes.offset.value,n[i]=a[0],n[i+1]=a[1],n[i+2]=a[2]),i+=3}return t.push(n.buffer),n}(e.instances,t),ellipsoid:e.ellipsoid,isGeographic:e.projection instanceof A.GeographicProjection,elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:e.modelMatrix,createPickOffsets:e.createPickOffsets,isfromGLP:null!=e.isfromGLP&&e.isfromGLP}},y.unpackCombineGeometryParameters=function(e){for(var t=function(e){for(var t=e,r=new Array(t[0]),n=0,i=1;i<t.length;){var o,a=c.Matrix4.unpack(t,i);i+=c.Matrix4.packedLength,v.defined(t[i])&&(o={offset:new l(t[i],t[i+1],t[i+2])}),i+=3,r[n++]={modelMatrix:a,attributes:o}}return r}(e.packedInstances),r=e.createGeometryResults,n=r.length,i=0,o=e.isfromGLP,a=0;a<n;a++)for(var s=y.unpackCreateGeometryResults(r[a]),d=s.length,p=0;p<d;p++){var f=s[p];t[i].geometry=f,++i}var u=m.Ellipsoid.clone(e.ellipsoid);return{instances:t,ellipsoid:u,projection:e.isGeographic?new A.GeographicProjection(u):new h.WebMercatorProjection(u),elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:c.Matrix4.clone(e.modelMatrix),createPickOffsets:e.createPickOffsets,isfromGLP:o}},y.packCombineGeometryResults=function(e,t){v.defined(e.geometries)&&o(e.geometries,t);var r=a(e.boundingSpheres),n=a(e.boundingSpheresCV);return t.push(r.buffer,n.buffer),{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:r,boundingSpheresCV:n,MaxMinArr:e.MaxMinArr}},y.unpackCombineGeometryResults=function(e){return{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:r(e.boundingSpheres),boundingSpheresCV:r(e.boundingSpheresCV),MaxMinArr:e.MaxMinArr}},e.PrimitivePipeline=y});
