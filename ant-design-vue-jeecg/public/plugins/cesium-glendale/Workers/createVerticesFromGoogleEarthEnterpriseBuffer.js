define(["./when-54c2dc71","./Check-6c0211bc","./Math-fc8cecf5","./Cartesian3-e5933291","./WebGLConstants-76bb35d1","./ComponentDatatype-6d99a1ee","./createTaskProcessorWorker","./Matrix4-a018fd55","./RuntimeError-2109023a","./Cartesian2-b1f4b655","./Transforms-b0e569fa","./AttributeCompression-2d47cb6b","./IntersectionTests-9d7ddacd","./Plane-6e6a4f39","./WebMercatorProjection-0e41bb58","./EllipsoidTangentPlane-6d5e3584","./OrientedBoundingBox-028c2054","./TerrainEncoding-cefb2ce3"],function(We,e,Fe,Oe,t,i,n,Ye,ke,Ue,Ve,a,r,o,He,Le,De,Ge){"use strict";var je=Uint16Array.BYTES_PER_ELEMENT,ze=Int32Array.BYTES_PER_ELEMENT,qe=Uint32Array.BYTES_PER_ELEMENT,Je=Float32Array.BYTES_PER_ELEMENT,Ke=Float64Array.BYTES_PER_ELEMENT;function Qe(e,t,i){i=We.defaultValue(i,Fe.CesiumMath);for(var n=e.length,a=0;a<n;++a)if(i.equalsEpsilon(e[a],t,Fe.CesiumMath.EPSILON12))return a;return-1}var Xe=new Ue.Cartographic,Ze=new Oe.Cartesian3,$e=new Oe.Cartesian3,et=new Oe.Cartesian3,tt=new Ye.Matrix4;function it(e,t,i,n,a,r,o,s,u,h){for(var c=o.length,d=0;d<c;++d){var g=o[d],l=g.cartographic,m=g.index,p=e.length,I=l.longitude,v=l.latitude,v=Fe.CesiumMath.clamp(v,-Fe.CesiumMath.PI_OVER_TWO,Fe.CesiumMath.PI_OVER_TWO),E=l.height-r.skirtHeight;r.hMin=Math.min(r.hMin,E),Ue.Cartographic.fromRadians(I,v,E,Xe),u&&(Xe.longitude+=s),u?d===c-1?Xe.latitude+=h:0===d&&(Xe.latitude-=h):Xe.latitude+=s;var T=r.ellipsoid.cartographicToCartesian(Xe);e.push(T),t.push(E),i.push(Ue.Cartesian2.clone(i[m])),0<n.length&&n.push(n[m]),Ye.Matrix4.multiplyByPoint(r.toENU,T,Ze);var C=r.minimum,f=r.maximum;Oe.Cartesian3.minimumByComponent(Ze,C,C),Oe.Cartesian3.maximumByComponent(Ze,f,f);var M,x=r.lastBorderPoint;We.defined(x)&&(M=x.index,a.push(M,p-1,p,p,m,M)),r.lastBorderPoint=g}}return n(function(e,t){e.ellipsoid=Ue.Ellipsoid.clone(e.ellipsoid),e.rectangle=Ue.Rectangle.clone(e.rectangle);var i=function(e,t,i,n,a,r,o,s,u,h){var c,d,g,l,m,p;p=We.defined(n)?(c=n.west,d=n.south,g=n.east,l=n.north,m=n.width,n.height):(c=Fe.CesiumMath.toRadians(a.west),d=Fe.CesiumMath.toRadians(a.south),g=Fe.CesiumMath.toRadians(a.east),l=Fe.CesiumMath.toRadians(a.north),m=Fe.CesiumMath.toRadians(n.width),Fe.CesiumMath.toRadians(n.height));var I,v,E=[d,l],T=[c,g],C=Ve.Transforms.eastNorthUpToFixedFrame(t,i),f=Ye.Matrix4.inverseTransformation(C,tt);s&&(I=He.WebMercatorProjection.geodeticLatitudeToMercatorAngle(d),v=1/(He.WebMercatorProjection.geodeticLatitudeToMercatorAngle(l)-I));var M=new DataView(e),x=Number.POSITIVE_INFINITY,N=Number.NEGATIVE_INFINITY,b=$e;b.x=Number.POSITIVE_INFINITY,b.y=Number.POSITIVE_INFINITY,b.z=Number.POSITIVE_INFINITY;var S=et;S.x=Number.NEGATIVE_INFINITY,S.y=Number.NEGATIVE_INFINITY,S.z=Number.NEGATIVE_INFINITY;var w,P,B=0,y=0,A=0;for(P=0;P<4;++P){var R=B;w=M.getUint32(R,!0),R+=qe;var _=Fe.CesiumMath.toRadians(180*M.getFloat64(R,!0));R+=Ke,-1===Qe(T,_)&&T.push(_);var W=Fe.CesiumMath.toRadians(180*M.getFloat64(R,!0));R+=Ke,-1===Qe(E,W)&&E.push(W),R+=2*Ke;var F=M.getInt32(R,!0);R+=ze,y+=F,F=M.getInt32(R,!0),A+=3*F,B+=w+qe}var O=[],Y=[],k=new Array(y),U=new Array(y),V=new Array(y),H=s?new Array(y):[],L=new Array(A),D=[],G=[],j=[],z=[],q=0,J=0;for(P=B=0;P<4;++P){w=M.getUint32(B,!0);var K=B+=qe,Q=Fe.CesiumMath.toRadians(180*M.getFloat64(B,!0));B+=Ke;var X=Fe.CesiumMath.toRadians(180*M.getFloat64(B,!0));B+=Ke;var Z=Fe.CesiumMath.toRadians(180*M.getFloat64(B,!0)),$=.5*Z;B+=Ke;var ee=Fe.CesiumMath.toRadians(180*M.getFloat64(B,!0)),te=.5*ee;B+=Ke;var ie=M.getInt32(B,!0);B+=ze;var ne=M.getInt32(B,!0);B+=ze,B+=ze;for(var ae=new Array(ie),re=0;re<ie;++re){var oe=Q+M.getUint8(B++)*Z;Xe.longitude=oe;var se=X+M.getUint8(B++)*ee;Xe.latitude=se;var ue=M.getFloat32(B,!0);if(B+=Je,0!==ue&&ue<h&&(ue*=-Math.pow(2,u)),ue*=6371010*r,Xe.height=ue,-1!==Qe(T,oe)||-1!==Qe(E,se)){var he=Qe(O,Xe,Ue.Cartographic);if(-1!==he){ae[re]=Y[he];continue}O.push(Ue.Cartographic.clone(Xe)),Y.push(q)}ae[re]=q,Math.abs(oe-c)<$?D.push({index:q,cartographic:Ue.Cartographic.clone(Xe)}):Math.abs(oe-g)<$?j.push({index:q,cartographic:Ue.Cartographic.clone(Xe)}):Math.abs(se-d)<te?G.push({index:q,cartographic:Ue.Cartographic.clone(Xe)}):Math.abs(se-l)<te&&z.push({index:q,cartographic:Ue.Cartographic.clone(Xe)}),x=Math.min(ue,x),N=Math.max(ue,N),V[q]=ue;var ce=i.cartographicToCartesian(Xe);k[q]=ce,s&&(H[q]=(He.WebMercatorProjection.geodeticLatitudeToMercatorAngle(se)-I)*v),Ye.Matrix4.multiplyByPoint(f,ce,Ze),Oe.Cartesian3.minimumByComponent(Ze,b,b),Oe.Cartesian3.maximumByComponent(Ze,S,S);var de=(oe-c)/(g-c);de=Fe.CesiumMath.clamp(de,0,1);var ge=(se-d)/(l-d);ge=Fe.CesiumMath.clamp(ge,0,1),U[q]=new Ue.Cartesian2(de,ge),++q}for(var le=3*ne,me=0;me<le;++me,++J)L[J]=ae[M.getUint16(B,!0)],B+=je;if(w!==B-K)throw new ke.RuntimeError("Invalid terrain tile.")}k.length=q,U.length=q,V.length=q,s&&(H.length=q);var pe=q,Ie=J,ve={hMin:x,lastBorderPoint:void 0,skirtHeight:o,toENU:f,ellipsoid:i,minimum:b,maximum:S};D.sort(function(e,t){return t.cartographic.latitude-e.cartographic.latitude}),G.sort(function(e,t){return e.cartographic.longitude-t.cartographic.longitude}),j.sort(function(e,t){return e.cartographic.latitude-t.cartographic.latitude}),z.sort(function(e,t){return t.cartographic.longitude-e.cartographic.longitude});var Ee=1e-5;{var Te,Ce,fe;it(k,V,U,H,L,ve,D,-Ee*m,!0,-Ee*p),it(k,V,U,H,L,ve,G,-Ee*p,!1),it(k,V,U,H,L,ve,j,Ee*m,!0,Ee*p),it(k,V,U,H,L,ve,z,Ee*p,!1),0<D.length&&0<z.length&&(Te=D[0].index,Ce=z[z.length-1].index,fe=k.length-1,L.push(Ce,fe,pe,pe,Te,Ce))}y=k.length;var Me,xe=Ve.BoundingSphere.fromPoints(k);We.defined(n)&&(Me=De.OrientedBoundingBox.fromRectangle(n,x,N,i));for(var Ne=new Ge.EllipsoidalOccluder(i).computeHorizonCullingPointPossiblyUnderEllipsoid(t,k,x),be=new Le.AxisAlignedBoundingBox(b,S,t),Se=new Ge.TerrainEncoding(be,ve.hMin,N,C,!1,s),we=new Float32Array(y*Se.getStride()),Pe=0,Be=0;Be<y;++Be)Pe=Se.encode(we,Pe,k[Be],U[Be],V[Be],void 0,H[Be]);var ye=D.map(function(e){return e.index}).reverse(),Ae=G.map(function(e){return e.index}).reverse(),Re=j.map(function(e){return e.index}).reverse(),_e=z.map(function(e){return e.index}).reverse();return Ae.unshift(Re[Re.length-1]),Ae.push(ye[0]),_e.unshift(ye[ye.length-1]),_e.push(Re[0]),{vertices:we,indices:new Uint16Array(L),maximumHeight:N,minimumHeight:x,encoding:Se,boundingSphere3D:xe,orientedBoundingBox:Me,occludeePointInScaledSpace:Ne,vertexCountWithoutSkirts:pe,indexCountWithoutSkirts:Ie,westIndicesSouthToNorth:ye,southIndicesEastToWest:Ae,eastIndicesNorthToSouth:Re,northIndicesWestToEast:_e}}(e.buffer,e.relativeToCenter,e.ellipsoid,e.rectangle,e.nativeRectangle,e.exaggeration,e.skirtHeight,e.includeWebMercatorT,e.negativeAltitudeExponentBias,e.negativeElevationThreshold),n=i.vertices;t.push(n.buffer);var a=i.indices;return t.push(a.buffer),{vertices:n.buffer,indices:a.buffer,numberOfAttributes:i.encoding.getStride(),minimumHeight:i.minimumHeight,maximumHeight:i.maximumHeight,boundingSphere3D:i.boundingSphere3D,orientedBoundingBox:i.orientedBoundingBox,occludeePointInScaledSpace:i.occludeePointInScaledSpace,encoding:i.encoding,vertexCountWithoutSkirts:i.vertexCountWithoutSkirts,indexCountWithoutSkirts:i.indexCountWithoutSkirts,westIndicesSouthToNorth:i.westIndicesSouthToNorth,southIndicesEastToWest:i.southIndicesEastToWest,eastIndicesNorthToSouth:i.eastIndicesNorthToSouth,northIndicesWestToEast:i.northIndicesWestToEast}})});
